---
- name: Get ESXi servers information
  vmware_host_facts:
    hostname: "{{ vcenter.hostname }}"
    username: "{{ vcenter.username }}"
    password: "{{ vcenter.password }}"
    esxi_hostname: "{{ esxi_hostname }}"
    validate_certs: no
  register: _vmware_host_facts
  loop: "{{ esxi.hostnames }}"
  loop_control:
    loop_var: esxi_hostname

- name: Check ESXi servers exist in cluster
  assert:
    that: "'{{ vcenter.cluster.name }}' == '{{ vmware_host_facts.ansible_facts.cluster }}'"
    success_msg: "ESXi server: {{ vmware_host_facts.esxi_hostname }} exists in Cluster: {{ vcenter.cluster.name }}"
  loop: "{{ _vmware_host_facts.results }}"
  loop_control:
    loop_var: vmware_host_facts